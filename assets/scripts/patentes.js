const patente = {
    "AA": "SANTA SEDE",
    "AC": "REPÚBLICA FEDERAL DE ALEMANIA",
    "AD": "REPÚBLICA DE ANGOLA",
    "AE": "REINO DE ARABIA SAUDITA",
    "AF": "REPÚBLICA ARGELINA DEMOCRÁTICA Y POPULAR",
    "AG": "REPÚBLICA DE ARMENIA",
    "AH": "MANCOMUNIDAD DE AUSTRALIA",
    "AI": "REPÚBLICA DE AUSTRIA",
    "AJ": "REPÚBLICA DE BELARÚS",
    "AK": "REINO DE BÉLGICA",
    "AL": "ESTADO PLURINACIONAL DE BOLIVIA",
    "AM": "REPÚBLICA FEDERATIVA DEL BRASIL",
    "AN": "REPÚBLICA DE BULGARIA",
    "AO": "CANADÁ",
    "AP": "REPÚBLICA CHECA",
    "AQ": "REPÚBLICA DE CHILE",
    "AR": "REPÚBLICA POPULAR CHINA",
    "AS": "REPÚBLICA DE COLOMBIA",
    "AT": "REPÚBLICA DEMOCRÁTICA DEL CONGO",
    "AU": "REPÚBLICA DE COREA",
    "AV": "REPÚBLICA DE COSTA RICA",
    "AW": "REPÚBLICA DE CROACIA",
    "AX": "REPÚBLICA DE CUBA",
    "AY": "REINO DE DINAMARCA",
    "AZ": "REPÚBLICA DOMINICANA",
    "BA": "REPÚBLICA DEL ECUADOR",
    "BB": "REPÚBLICA ÁRABE DE EGIPTO",
    "BC": "REPÚBLICA DE EL SALVADOR",
    "BD": "EMIRATOS ÁRABES UNIDOS",
    "BE": "REPÚBLICA ESLOVACA",
    "BF": "REPÚBLICA DE ESLOVENIA",
    "BG": "REINO DE ESPAÑA",
    "BH": "ESTADOS UNIDOS DE AMÉRICA",
    "BI": "REPÚBLICA DE FILIPINAS",
    "BJ": "REPÚBLICA DE FINLANDIA",
    "BK": "REPÚBLICA FRANCESA",
    "BL": "REPÚBLICA HELÉNICA",
    "BM": "REPÚBLICA DE GUATEMALA",
    "BN": "REPÚBLICA DE HAITÍ",
    "BO": "REPÚBLICA DE HONDURAS",
    "BP": "HUNGRÍA",
    "BQ": "REPÚBLICA DE LA INDIA",
    "BR": "REPÚBLICA DE INDONESIA",
    "BS": "REPÚBLICA ISLÁMICA DE IRÁN",
    "BT": "IRLANDA",
    "BU": "ESTADO DE ISRAEL",
    "BV": "REPÚBLICA ITALIANA",
    "BW": "JAPÓN",
    "BX": "ESTADO DE KUWAIT",
    "BY": "REPÚBLICA LIBANESA",
    "BZ": "ESTADO DE LIBIA",
    "CB": "MALASIA",
    "CC": "SOBERANA ORDEN MILITAR DE MALTA",
    "CD": "REINO DE MARRUECOS",
    "CE": "ESTADOS UNIDOS MEXICANOS",
    "CF": "REPÚBLICA DE NICARAGUA",
    "CG": "REPÚBLICA FEDERAL DE NIGERIA",
    "CH": "REINO DE NORUEGA",
    "CI": "NUEVA ZELANDIA",
    "CJ": "REINO DE LOS PAÍSES BAJOS",
    "CK": "REPÚBLICA ISLÁMICA DE PAKISTÁN",
    "CL": "REPÚBLICA DE PANAMÁ",
    "CM": "REPÚBLICA DEL PARAGUAY",
    "CN": "REPÚBLICA DEL PERÚ",
    "CO": "REPÚBLICA DE POLONIA",
    "CP": "REPÚBLICA PORTUGUESA",
    "CQ": "REINO UNIDO DE GRAN BRETAÑA E IRLANDA DEL NORTE",
    "CR": "RUMANIA",
    "CS": "FEDERACIÓN DE RUSIA",
    "CU": "REPÚBLICA DE SERBIA",
    "CV": "REPÚBLICA ÁRABE SIRIA",
    "CW": "REPÚBLICA DE SUDÁFRICA",
    "CX": "REINO DE SUECIA",
    "CY": "CONFEDERACIÓN SUIZA",
    "CZ": "REINO DE TAILANDIA",
    "DA": "REPÚBLICA TUNECINA",
    "DB": "REPÚBLICA DE TURQUÍA",
    "DC": "UCRANIA",
    "DD": "REPÚBLICA ORIENTAL DEL URUGUAY",
    "DE": "REPÚBLICA BOLIVARIANA DE VENEZUELA",
    "DF": "REPÚBLICA SOCIALISTA DE VIETNAM",
    "DG": "UNIÓN EUROPEA",
    "DH": "LIGA DE LOS ESTADOS ÁRABES",
    "DI": "ESTADO DE PALESTINA",
    "DJ": "REPÚBLICA DE AZERBAIYÁN",
    "DK": "GEORGIA",
    "DL": "ESTADO DE QATAR",
    "DM": "MONTENEGRO",
    "RA": "ALTO COMISIONADO DE LAS NACIONES UNIDAS PARA LOS REFUGIADOS",
    "RB": "BANCO INTERAMERICANO DE DESARROLLO",
    "RC": "BANCO INTERNACIONAL DE RECONSTRUCCIÓN Y DESARROLLO",
    "RD": "CENTRO DE INFORMACIÓN DE LAS NACIONES UNIDAS PARA ARGENTINA Y URUGUAY",
    "RE": "COMISIÓN ADMINISTRADORA DEL RIO DE LA PLATA",
    "RF": "COMISIÓN ADMINISTRADORA DEL RÍO URUGUAY",
    "RG": "COMISIÓN MIXTA ARGENTINO PARAGUAYA DEL RÍO PARANÁ",
    "RH": "COMITÉ INTERNACIONAL DE LA CRUZ ROJA",
    "RI": "CORPORACIÓN ANDINA DE FOMENTO",
    "RJ": "CORPORACIÓN FINANCIERA INTERNACIONAL",
    "RK": "ENTIDAD BINACIONAL YACIRETÁ",
    "RL": "FONDO DE LAS NACIONES UNIDAS PARA LA INFANCIA",
    "RM": "FONDO MONETARIO INTERNACIONAL",
    "RN": "INSTITUTO INTERAMERICANO DE COOPERACIÓN PARA LA AGRICULTURA",
    "RO": "ORGANIZACIÓN DE ESTADOS IBEROAMERICANOS PARA LA EDUCACIÓN, LA CIENCIA Y LA CULTURA",
    "RP": "ORGANIZACIÓN DE LAS NACIONES UNIDAS PARA LA AGRICULTURA Y LA ALIMENTACIÓN",
    "RQ": "ORGANIZACIÓN IBEROAMERICANO DE SEGURIDAD SOCIAL",
    "RR": "ORGANIZACIÓN INTERNACIONAL DE POLICIA CRIMINAL",
    "RS": "ORGANIZACIÓN INTERNACIONAL DEL TRABAJO",
    "RT": "ORGANIZACION INTERNACIONAL PARA LAS MIGRACIONES",
    "RU": "ORGANIZACIÓN PANAMERICANA DE LA SALUD - OPS/OMS",
    "RV": "PROGRAMA COMÚN DE LAS NACIONES UNIDAS SOBRE VIH/SIDA",
    "RW": "SISTEMA DE LAS NACIONES UNIDAS",
    "RX": "REPRES. SECRET. GRAL. OEA EN ARGENTINA",
    "RY": "SECRETARÍA DEL TRATADO ANTÁRTICO",
    "RZ": "FEDERACIÓN INTERNACIONAL DE SOCIEDADES DE LA CRUZ ROJA",
    "SA": "REPRESENTACIÓN REGIONAL PARA LAS AMÉRICAS DE LA ORGANIZACIÓN MUNDIAL DE SANIDAD ANIMAL",
    "SB": "OFICINA DE LAS NACIONES UNIDAS PARA LOS PROYECTOS",
    "SC": "CENTRO DE ESTUDIOS ESTRATÉGICOS DE DEFENSA DEL CONSEJO DE DEFENSA SURAMERICANO DEL UNASUR - CEED",
    "SD": "COMISIÓN TRINACIONAL PARA EL DESARROLLO DE LA CUENCA DEL RÍO PILCOMAYO",
    "SE": "COMISIÓN ECONÓMICA PARA AMÉRICA LATINA Y EL CARIBE - CEPAL",
    "XA": "AGENCIA DE COOPERACIÓN INTERNACIONAL DEL JAPÓN (JICA)",
    "XB": "FUNDACIÓN KONRAD ADENAUER",
    "XC": "FUNDACIÓN HANNS SEIDEL",
    "XD": "FUNDACIÓN FRIEDRICH NAUMANN",
    "XE": "FUNDACIÓN FRIEDRICH EBERT"
}

const categoria = {
    "D": "CUERPO DIPLOMATICO",
    "I": "ORGANISMO INTERNACIONAL",
    "C": "CUERPO CONSULAR",
    "A": "PERSONAL ADMINISTRATIVO",
    "M": "MISION ESPECIAL"
}

function obtenerPais(codigo) {
    const pick = patente[codigo];
    if (pick === undefined) {
        return "País no encontrado";
    }
    return pick;
}

function obtenerCategoria(codigo) {
    const pick = categoria[codigo];
    if (pick === undefined) {
        return "Categoría no encontrada";
    }
    return pick;
}

function sanitizeInput(input) {
    const patenteClean = input.toUpperCase().trim();
    let error = null;
    let categoria = null;
    let categoriaTraduccion = null;
    let usoJefe = false;
    /* 
        La patente puede ser ya sea XX (teniendo el codigo pais directo) o dentro de un string mas largo, sea D039CPX, siendo CP el codigo de la REPÚBLICA PORTUGUESA.
    */
    const regexCodigoPais = /[A-Z]{2}/;
    const match = patenteClean.match(regexCodigoPais);
    if (match === null) {
        error = "Código de país no encontrado";
        return {
            codigo: null,
            categoria,
            error
        }
    }


    // D039CPX -> X000XXX
    const patenteCompletaRegex = /[A-Z]{1}\d{3}[A-Z]{3}/;
    const esPatenteCompleta = patenteClean.length > 2 && patenteClean.match(patenteCompletaRegex)
    if (esPatenteCompleta) {
        const regexCategoria = /[A-Z]{1}/;
        const matchCategoria = patenteClean.match(regexCategoria);
        if (matchCategoria !== null) {
            categoria = obtenerCategoria(matchCategoria[0]);
            categoriaTraduccion = matchCategoria[0];
        } else {
            error = "Categoría no encontrada";
        }
        // La ultima letra determina si es uso de jefe de misión o no.
        usoJefe = patenteClean[patenteClean.length - 1] === 'A';
    }

    return {
        codigo: match[0],
        categoria,
        categoriaTraduccion,
        error,
        usoJefe
    }
}

function clearResults() {
    const ids = ['codigo', 'categoria', 'categoria-traduccion', 'traduccion', 'uso-jefe']
    for (let id of ids) {
        document.getElementById(id).innerHTML = "";
    }
}

function clearError() {
    document.getElementById('error').innerHTML = "";
}

function clearSearchParams() {
    const url = new URL(window.location.href);
    url.searchParams.delete('patente');
    window.history.replaceState({}, '', url);
}

function mostrarCapturar() {
    document.getElementById('capturar').style.display = 'inline';
}

function ocultarCapturar() {
    document.getElementById('capturar').style.display = 'none';
}

function handleCapturar() {
    const patente = document.getElementById('patente').value;
    navigator.geolocation.getCurrentPosition((position) => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        addPatente(patente, lat, lon)
    }, (error) => {
        if (error.code === 1) {
            alert("Por favor, permita el acceso a la ubicación para poder capturar la patente");
        } else {
            console.error(error);
        }
    });
}

function addPatente(patente, lat, lon) {
    const patentes = JSON.parse(localStorage.getItem('patentes')) || [];

    const alreadyInList = patentes.some((item) => item.patente === patente);
    if (alreadyInList) {
        return alert("Patente ya capturada en el pasado");
    }

    patentes.push({
        patente,
        lat,
        lon,
        date: new Date().toISOString()
    });
    localStorage.setItem('patentes', JSON.stringify(patentes));
    alert("Patente capturada con éxito");
    ocultarCapturar();

    actualizarLista();
}

function actualizarLista() {
    const patentes = JSON.parse(localStorage.getItem('patentes')) || [];
    const list = document.getElementById('patentes-capturadas');
    list.innerHTML = "<br><hr><h2>Patentes capturadas</h2>";
    if (patentes.length === 0) {
        list.innerHTML = "";
        return
    }
    patentes.forEach((item) => {
        const li = document.createElement('li');
        li.classList.add('patente-item');
        li.innerHTML = `${item.patente} - ${item.date} - 
            <button id="ver-detalle" data-patente="${item.patente}">Ver detalle</button>
            <button id="ver-mapa" data-lat="${item.lat}" data-lon="${item.lon}" data-patente="${item.patente}">Ver en mapa</button>
            <button id="eliminar" data-patente="${item.patente}">Eliminar</button>
            `;
        list.appendChild(li);
    });
    list.addEventListener('click', handleListClick);
}

function handleListClick(event) {
    if (event.target.id === 'ver-detalle') {
        const patente = event.target.dataset.patente;
        document.getElementById('patente').value = patente;
        document.getElementById('form-patente').dispatchEvent(new Event('submit'));
    } else if (event.target.id === 'ver-mapa') {
        const lat = parseFloat(event.target.dataset.lat);
        const lon = parseFloat(event.target.dataset.lon);
        const patente = event.target.dataset.patente;
        showMap(lat, lon, patente);
    } else if (event.target.id === 'eliminar') {
        const patente = event.target.dataset.patente;
        const patentes = JSON.parse(localStorage.getItem('patentes')) || [];
        const newPatentes = patentes.filter((item) => item.patente !== patente);
        localStorage.setItem('patentes', JSON.stringify(newPatentes));
        actualizarLista();
    }
}

function showMap(lat, lon, patente) {
    const dialog = document.getElementById('map-dialog');
    const container = document.getElementById('map-container');
    const title = document.getElementById('map-title');
    title.innerHTML = patente;
    
    // Limpiar mapa anterior si existe
    container.innerHTML = '';
    
    // Crear iframe de mapa usando OpenStreetMap
    container.innerHTML = `<iframe width="100%" height="400" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" 
        src="https://www.openstreetmap.org/export/embed.html?bbox=${lon-0.01},${lat-0.01},${lon+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lon}" 
        style="border: 1px solid black"></iframe>
        <br/>
        <small class="map-link"><a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}&zoom=15" target="_blank">Ver en OpenStreetMap</a></small>`;
    
    // Mostrar el diálogo
    dialog.showModal();
}